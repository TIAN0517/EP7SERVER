# RANOnline EP7 AIç³»ç»Ÿ - å‰ç«¯ç®¡ç†ç•Œé¢ CMakeé…ç½®
# å¼€å‘å›¢é˜Ÿ: JyæŠ€æœ¯å›¢é˜Ÿ
# åˆ›å»ºæ—¥æœŸ: 2025å¹´6æœˆ14æ—¥

cmake_minimum_required(VERSION 3.20)

# ================================================
# ğŸ“‹ é¡¹ç›®é…ç½®
# ================================================
set(TARGET_NAME "ai_frontend_manager")
set(PROJECT_DESCRIPTION "RANOnline AI Frontend Manager - Ultimate C++ Edition")

# ================================================
# ğŸ” æŸ¥æ‰¾ä¾èµ–åŒ…
# ================================================

# Qt6ç»„ä»¶
find_package(Qt6 REQUIRED COMPONENTS 
    Core 
    Widgets 
    Network 
    Concurrent
    Svg
    Charts
)

# ================================================
# ğŸ“ æºæ–‡ä»¶æ”¶é›†
# ================================================

# å¤´æ–‡ä»¶
set(HEADERS
    MainWindow.h
    AiControlPanel.h
    StatusMonitor.h
    LogViewer.h
    NetworkManager.h
    PerformanceMonitor.h
    LoadBalancer.h
)

# æºæ–‡ä»¶
set(SOURCES
    main.cpp
    MainWindow.cpp
    AiControlPanel.cpp
    StatusMonitor.cpp
    LogViewer.cpp
    NetworkManager.cpp
    PerformanceMonitor.cpp
    LoadBalancer.cpp
)

# UIæ–‡ä»¶ï¼ˆå¦‚æœä½¿ç”¨Qt Designerï¼‰
set(UI_FILES
    # MainWindow.ui
    # AiControlPanel.ui
)

# èµ„æºæ–‡ä»¶
set(RESOURCE_FILES
    resources.qrc
)

# ================================================
# ğŸ¯ å¯æ‰§è¡Œæ–‡ä»¶ç›®æ ‡
# ================================================
add_executable(${TARGET_NAME}
    ${HEADERS}
    ${SOURCES}
    ${UI_FILES}
    ${RESOURCE_FILES}
)

# ================================================
# ğŸ”— é“¾æ¥åº“
# ================================================
target_link_libraries(${TARGET_NAME}
    PRIVATE
        Qt6::Core
        Qt6::Widgets
        Qt6::Network
        Qt6::Concurrent
        Qt6::Svg
        Qt6::Charts
        communication_protocol
        database_sync_module
)

# Windowså¹³å°ç‰¹å®šé“¾æ¥
if(WIN32)
    target_link_libraries(${TARGET_NAME}
        PRIVATE
            user32
            gdi32
            shell32
            ole32
            oleaut32
            uuid
            winmm
            imm32
            ws2_32
    )
endif()

# ================================================
# ğŸ“ åŒ…å«ç›®å½•
# ================================================
target_include_directories(${TARGET_NAME}
    PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_SOURCE_DIR}/../Communication_Protocol
        ${CMAKE_CURRENT_SOURCE_DIR}/../Database_Sync_Module
)

# ================================================
# ğŸ”§ ç¼–è¯‘å™¨ç‰¹å®šè®¾ç½®
# ================================================

# MSVCç¼–è¯‘å™¨è®¾ç½®
if(MSVC)
    target_compile_options(${TARGET_NAME} PRIVATE
        /W4                    # è­¦å‘Šçº§åˆ«4
        /WX-                   # è­¦å‘Šä¸ä½œä¸ºé”™è¯¯å¤„ç†
        /MP                    # å¤šæ ¸ç¼–è¯‘
        /permissive-           # ä¸¥æ ¼æ¨¡å¼
        /Zc:__cplusplus        # æ­£ç¡®çš„__cpluspluså®
        /utf-8                 # UTF-8æºä»£ç ç¼–ç 
    )
    
    # Debugé…ç½®
    target_compile_options(${TARGET_NAME} PRIVATE
        $<$<CONFIG:Debug>:/Od>     # ç¦ç”¨ä¼˜åŒ–
        $<$<CONFIG:Debug>:/Zi>     # ç”Ÿæˆè°ƒè¯•ä¿¡æ¯
        $<$<CONFIG:Debug>:/RTC1>   # è¿è¡Œæ—¶æ£€æŸ¥
    )
    
    # Releaseé…ç½®
    target_compile_options(${TARGET_NAME} PRIVATE
        $<$<CONFIG:Release>:/O2>   # æœ€å¤§ä¼˜åŒ–
        $<$<CONFIG:Release>:/GL>   # å…¨ç¨‹åºä¼˜åŒ–
        $<$<CONFIG:Release>:/LTCG> # é“¾æ¥æ—¶ä»£ç ç”Ÿæˆ
    )
endif()

# GCC/Clangç¼–è¯‘å™¨è®¾ç½®
if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    target_compile_options(${TARGET_NAME} PRIVATE
        -Wall
        -Wextra
        -Wpedantic
        -Wno-unused-parameter
    )
    
    # Debugé…ç½®
    target_compile_options(${TARGET_NAME} PRIVATE
        $<$<CONFIG:Debug>:-g>
        $<$<CONFIG:Debug>:-O0>
        $<$<CONFIG:Debug>:-fsanitize=address>
    )
    
    # Releaseé…ç½®
    target_compile_options(${TARGET_NAME} PRIVATE
        $<$<CONFIG:Release>:-O3>
        $<$<CONFIG:Release>:-DNDEBUG>
        $<$<CONFIG:Release>:-flto>
    )
endif()

# ================================================
# ğŸ¨ é¢„ç¼–è¯‘å®šä¹‰
# ================================================
target_compile_definitions(${TARGET_NAME}
    PRIVATE
        # Qtç›¸å…³å®šä¹‰
        QT_DEPRECATED_WARNINGS
        QT_DISABLE_DEPRECATED_BEFORE=0x060000
        QT_NO_DEBUG_OUTPUT=$<NOT:$<CONFIG:Debug>>
        
        # åº”ç”¨ç¨‹åºä¿¡æ¯
        APP_NAME="${TARGET_NAME}"
        APP_VERSION="${PROJECT_VERSION}"
        APP_DESCRIPTION="${PROJECT_DESCRIPTION}"
        
        # Windowså¹³å°å®šä¹‰
        $<$<PLATFORM_ID:Windows>:
            UNICODE
            _UNICODE
            WIN32_LEAN_AND_MEAN
            NOMINMAX
            _CRT_SECURE_NO_WARNINGS
        >
        
        # Debugæ¨¡å¼å®šä¹‰
        $<$<CONFIG:Debug>:
            DEBUG
            _DEBUG
            AI_SYSTEM_DEBUG
        >
        
        # Releaseæ¨¡å¼å®šä¹‰
        $<$<CONFIG:Release>:
            NDEBUG
            QT_NO_DEBUG
        >
)

# ================================================
# ğŸ“„ èµ„æºæ–‡ä»¶å¤„ç†
# ================================================

# åˆ›å»ºèµ„æºæ–‡ä»¶ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
set(RESOURCE_QRC_FILE "${CMAKE_CURRENT_SOURCE_DIR}/resources.qrc")
if(NOT EXISTS ${RESOURCE_QRC_FILE})
    file(WRITE ${RESOURCE_QRC_FILE}
        "<!DOCTYPE RCC>\n"
        "<RCC version=\"1.0\">\n"
        "  <qresource>\n"
        "    <!-- Icons -->\n"
        "    <file alias=\"icons/app_icon.ico\">icons/app_icon.ico</file>\n"
        "    <file alias=\"icons/ai_icon.png\">icons/ai_icon.png</file>\n"
        "    <file alias=\"icons/server_icon.png\">icons/server_icon.png</file>\n"
        "    \n"
        "    <!-- Styles -->\n"
        "    <file alias=\"styles/cyberpunk.qss\">styles/cyberpunk.qss</file>\n"
        "    <file alias=\"styles/neon_glow.qss\">styles/neon_glow.qss</file>\n"
        "    \n"
        "    <!-- Images -->\n"
        "    <file alias=\"images/splash.png\">images/splash.png</file>\n"
        "    <file alias=\"images/background.png\">images/background.png</file>\n"
        "  </qresource>\n"
        "</RCC>\n"
    )
endif()

# ================================================
# ğŸ“¦ å®‰è£…é…ç½®
# ================================================
install(TARGETS ${TARGET_NAME}
    RUNTIME DESTINATION bin
    BUNDLE DESTINATION .
)

# å®‰è£…Qtåº“ï¼ˆWindowsï¼‰
if(WIN32)
    # æŸ¥æ‰¾windeployqtå·¥å…·
    find_program(WINDEPLOYQT_EXECUTABLE windeployqt HINTS ${Qt6_DIR}/../../../bin)
    
    if(WINDEPLOYQT_EXECUTABLE)
        # æ·»åŠ éƒ¨ç½²å‘½ä»¤
        install(CODE "
            execute_process(
                COMMAND ${WINDEPLOYQT_EXECUTABLE} --qmldir ${CMAKE_SOURCE_DIR} \$ENV{DESTDIR}\${CMAKE_INSTALL_PREFIX}/bin/${TARGET_NAME}.exe
                RESULT_VARIABLE result
            )
            if(NOT result EQUAL 0)
                message(WARNING \"windeployqt failed\")
            endif()
        ")
    endif()
endif()

# ================================================
# ğŸ·ï¸ ç›®æ ‡å±æ€§è®¾ç½®
# ================================================
set_target_properties(${TARGET_NAME} PROPERTIES
    # åŸºæœ¬å±æ€§
    OUTPUT_NAME "RANOnline_AI_Frontend"
    VERSION ${PROJECT_VERSION}
    SOVERSION ${PROJECT_VERSION_MAJOR}
    
    # C++æ ‡å‡†
    CXX_STANDARD 20
    CXX_STANDARD_REQUIRED ON
    CXX_EXTENSIONS OFF
    
    # Windowsç‰¹å®šå±æ€§
    WIN32_EXECUTABLE TRUE
    
    # è°ƒè¯•ä¿¡æ¯
    $<$<CONFIG:Debug>:
        COMPILE_PDB_NAME "${TARGET_NAME}_debug"
        COMPILE_PDB_OUTPUT_DIRECTORY "${CMAKE_CURRENT_BINARY_DIR}"
    >
    
    # è¾“å‡ºç›®å½•
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/bin"
    LIBRARY_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
    ARCHIVE_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}/lib"
)

# ================================================
# ğŸ“Š æ„å»ºä¿¡æ¯è¾“å‡º
# ================================================
message(STATUS "")
message(STATUS "ğŸ¯ Frontend Manager Configuration:")
message(STATUS "   Target Name: ${TARGET_NAME}")
message(STATUS "   Output Name: RANOnline_AI_Frontend")
message(STATUS "   Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "   Qt Version: ${Qt6_VERSION}")
message(STATUS "   Install Dir: ${CMAKE_INSTALL_PREFIX}")
message(STATUS "")
