cmake_minimum_required(VERSION 3.22)
project(ai_llm_integration VERSION 1.0.0 LANGUAGES CXX)

# è¨­ç½®C++æ¨™æº–
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# éœæ…‹éˆæ¥é¸é …
option(BUILD_PORTABLE "Build portable application with static linking" ON)
option(DEPLOY_QT "Deploy Qt libraries automatically" ON)

# ä¾¿æ”œå¼æ§‹å»ºè¨­ç½®
if(BUILD_PORTABLE)
    if(MSVC)
        set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /MT")
    elseif(MINGW)
        # MinGWéœæ…‹éˆæ¥è¨­ç½®
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -static-libgcc -static-libstdc++")
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static")
    endif()
    add_compile_definitions(STATIC_QT_BUILD)
    message(STATUS "ğŸš€ Building portable application with static linking")
endif()

# Qt6è¨­ç½®
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# æŸ¥æ‰¾Qt6
find_package(Qt6 REQUIRED COMPONENTS Core Widgets Network)

# æ¢ä»¶æ€§æŸ¥æ‰¾WebSockets
find_package(Qt6WebSockets QUIET)
if(Qt6WebSockets_FOUND)
    message(STATUS "âœ… Qt6WebSockets found, WebSocket features enabled")
    set(HAVE_WEBSOCKETS ON)
else()
    message(WARNING "âš ï¸ Qt6WebSockets not found, WebSocket features will be disabled")
    set(HAVE_WEBSOCKETS OFF)
endif()

# æŸ¥æ‰¾å…¶ä»–å¯èƒ½éœ€è¦çš„Qtæ¨¡å—
find_package(Qt6 QUIET COMPONENTS Concurrent Gui)
if(Qt6Concurrent_FOUND)
    message(STATUS "âœ… Qt6Concurrent found")
endif()
if(Qt6Gui_FOUND)
    message(STATUS "âœ… Qt6Gui found")
endif()

# ç·¨è­¯å™¨ç‰¹å®šè¨­ç½®
if(MSVC)
    add_compile_options(/utf-8 /Zc:__cplusplus /W3 /permissive- /FS)
    add_compile_definitions(_CRT_SECURE_NO_WARNINGS)
endif()

# å®šç¾©ç‰¹æ€§å®
if(HAVE_WEBSOCKETS)
    add_compile_definitions(HAVE_WEBSOCKETS)
endif()

# æºæ–‡ä»¶
set(SOURCES
    main.cpp
    FramelessWindow.cpp
    CyberProgressBar.cpp
    LLMMainWindow.cpp
    LLMRequestItem_New.cpp
    OllamaLLMManager_Fixed.cpp
    
    # AIç®¡æ§ç³»çµ±æ¨¡çµ„
    AIPlayerGenerator.cpp
    AIDecisionEngine.cpp
    AIManagementWidget.cpp
)

# é ­æ–‡ä»¶
set(HEADERS
    AcademyTheme.h
    FramelessWindow.h
    CyberProgressBar.h
    LLMRequestItem_New.h
    LLMMainWindow.h
    OllamaLLMManager.h
    
    # AIç®¡æ§ç³»çµ±æ¨¡çµ„
    AIPlayerGenerator.h
    AIDecisionEngine.h
    AIManagementWidget.h
)

# å‰µå»ºå¯åŸ·è¡Œæ–‡ä»¶
add_executable(ai_llm_integration ${SOURCES} ${HEADERS})

# è¨­ç½®ç·¨è­¯é¸é …
target_compile_options(ai_llm_integration PRIVATE 
    $<$<CXX_COMPILER_ID:MSVC>:/FS>
)

# éˆæ¥åº«
target_link_libraries(ai_llm_integration 
    Qt6::Core 
    Qt6::Widgets 
    Qt6::Network
)

# ä¾¿æ”œå¼æ§‹å»ºè¨­ç½®
if(BUILD_PORTABLE)
    # è¨­ç½®éœæ…‹éˆæ¥æ¨™å¿—
    set_target_properties(ai_llm_integration PROPERTIES
        WIN32_EXECUTABLE TRUE
    )
    
    # MinGWé¡å¤–çš„éœæ…‹åº«éˆæ¥
    if(MINGW)
        target_link_libraries(ai_llm_integration 
            ws2_32 winmm imm32 version
        )
    endif()
    
    message(STATUS "ğŸ”— Static linking configured for portable build")
endif()

# æ¢ä»¶æ€§éˆæ¥é¡å¤–æ¨¡çµ„
if(Qt6Concurrent_FOUND)
    target_link_libraries(ai_llm_integration Qt6::Concurrent)
    message(STATUS "âœ… Linking Qt6::Concurrent")
endif()

if(Qt6Gui_FOUND)
    target_link_libraries(ai_llm_integration Qt6::Gui)
    message(STATUS "âœ… Linking Qt6::Gui")
endif()

# æ¢ä»¶æ€§éˆæ¥WebSockets
if(HAVE_WEBSOCKETS)
    target_link_libraries(ai_llm_integration Qt6::WebSockets)
    message(STATUS "âœ… Linking Qt6::WebSockets")
endif()

# è¼¸å‡ºé…ç½®ä¿¡æ¯
message(STATUS "")
message(STATUS "ğŸ¤– AI LLM Integration Module Configuration")
message(STATUS "============================================")
message(STATUS "ğŸ“‹ Module Version: ${PROJECT_VERSION}")
message(STATUS "ğŸ¯ Qt6 Version: ${Qt6_VERSION}")
message(STATUS "ğŸ”§ Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "ğŸ“ Source Directory: ${CMAKE_SOURCE_DIR}")
message(STATUS "ğŸ“¦ Binary Directory: ${CMAKE_BINARY_DIR}")
message(STATUS "ğŸŒ Translation Support: Enabled")
if(HAVE_WEBSOCKETS)
    message(STATUS "ğŸ”Œ WebSocket Support: Enabled")
else()
    message(STATUS "ğŸ”Œ WebSocket Support: Disabled")
endif()
message(STATUS "============================================")
message(STATUS "")

# å‰µå»ºæ¼”ç¤ºç¨‹åº - æš«æ™‚ç§»é™¤WebSocketä¾è³´
# add_executable(game_ai_demo
#     GameAIDemo.cpp
#     GameAIProtocol.cpp
#     GameWebSocketClient.cpp
#     GameWebSocketServer.cpp
# )

# target_link_libraries(game_ai_demo
#     Qt6::Core
#     Qt6::Network
# )

# æ¢ä»¶æ€§éˆæ¥WebSocketsåˆ°æ¼”ç¤ºç¨‹åº
if(HAVE_WEBSOCKETS)
    target_link_libraries(game_ai_demo Qt6::WebSockets)
    message(STATUS "âœ… Demo program will include WebSocket support")
else()
    message(STATUS "âš ï¸ Demo program will run with limited functionality")
endif()

# è¼¸å‡ºæ¼”ç¤ºç¨‹åºä¿¡æ¯
message(STATUS "")
message(STATUS "ğŸ® Game AI Demo Program Configuration")
message(STATUS "======================================")
message(STATUS "ğŸ“‹ Demo executable: game_ai_demo")
message(STATUS "ğŸ”Œ WebSocket Demo: ${HAVE_WEBSOCKETS}")
message(STATUS "======================================")

# éƒ¨ç½²é…ç½®
if(DEPLOY_QT AND WIN32)
    # æŸ¥æ‰¾windeployqtå·¥å…·
    find_program(WINDEPLOYQT_EXECUTABLE windeployqt HINTS ${QT_INSTALL_PATH}/bin)
    
    if(WINDEPLOYQT_EXECUTABLE)
        message(STATUS "ğŸš€ Found windeployqt: ${WINDEPLOYQT_EXECUTABLE}")
        
        # å‰µå»ºéƒ¨ç½²ç›®éŒ„
        set(DEPLOY_DIR "${CMAKE_BINARY_DIR}/deploy")
        
        # éƒ¨ç½²å‘½ä»¤
        add_custom_target(deploy
            COMMAND ${CMAKE_COMMAND} -E make_directory ${DEPLOY_DIR}
            COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:ai_llm_integration> ${DEPLOY_DIR}/
            COMMAND ${WINDEPLOYQT_EXECUTABLE} --qmldir ${CMAKE_SOURCE_DIR} --release --no-translations --no-system-d3d-compiler --no-opengl-sw ${DEPLOY_DIR}/ai_llm_integration.exe
            DEPENDS ai_llm_integration
            COMMENT "ğŸš€ Deploying Qt libraries for portable distribution"
        )
        
        # å‰µå»ºä¾¿æ”œå¼æ‰“åŒ…
        add_custom_target(portable
            COMMAND ${CMAKE_COMMAND} -E make_directory ${DEPLOY_DIR}/portable
            COMMAND ${CMAKE_COMMAND} -E copy_directory ${DEPLOY_DIR} ${DEPLOY_DIR}/portable
            COMMAND ${CMAKE_COMMAND} -E remove ${DEPLOY_DIR}/portable/ai_llm_integration.exe
            COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:ai_llm_integration> ${DEPLOY_DIR}/portable/
            DEPENDS deploy
            COMMENT "ğŸ“¦ Creating portable application package"
        )
        
        message(STATUS "âœ… Deployment targets configured: 'deploy' and 'portable'")
    else()
        message(WARNING "âš ï¸ windeployqt not found, deployment targets disabled")
    endif()
endif()

# å®‰è£è¦å‰‡
install(TARGETS ai_llm_integration
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
)

# æœ€çµ‚é…ç½®è¼¸å‡º
message(STATUS "")
message(STATUS "ğŸ¯ Build Configuration Summary")
message(STATUS "===============================")
message(STATUS "ğŸ“¦ Portable Build: ${BUILD_PORTABLE}")
message(STATUS "ğŸš€ Auto Deploy: ${DEPLOY_QT}")
message(STATUS "ğŸ® Target: ai_llm_integration.exe")
message(STATUS "===============================")
message(STATUS "")
message(STATUS "ğŸ’¡ Usage:")
message(STATUS "   make ai_llm_integration  - Build application")
if(DEPLOY_QT)
    message(STATUS "   make deploy             - Deploy Qt dependencies")
    message(STATUS "   make portable           - Create portable package")
endif()
message(STATUS "")