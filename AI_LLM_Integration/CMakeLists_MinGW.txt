cmake_minimum_required(VERSION 3.22)
project(ai_llm_integration VERSION 1.0.0 LANGUAGES CXX)

# è¨­ç½®C++æ¨™æº–
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# å¼·åˆ¶ä½¿ç”¨MinGWç·¨è­¯å™¨è¨­ç½®
if(WIN32)
    # ç¢ºä¿ä½¿ç”¨MinGWå·¥å…·éˆ
    if(NOT CMAKE_CXX_COMPILER_ID STREQUAL "GNU")
        message(FATAL_ERROR "âŒ æ­¤å°ˆæ¡ˆéœ€è¦MinGWç·¨è­¯å™¨ã€‚è«‹ç¢ºä¿PATHä¸­åŒ…å«MinGWçš„binç›®éŒ„ã€‚")
    endif()
    
    # MinGWç‰¹å®šè¨­ç½®
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")
    set(CMAKE_CXX_FLAGS_DEBUG "${CMAKE_CXX_FLAGS_DEBUG} -g -O0")
    
    # ç§»é™¤æ‰€æœ‰MSVCç›¸é—œè¨­ç½®
    add_compile_definitions(WIN32_LEAN_AND_MEAN)
    
    message(STATUS "ğŸ”§ MinGWç·¨è­¯å™¨é…ç½®å®Œæˆ")
endif()

# ä¾¿æ”œå¼æ§‹å»ºé¸é …
option(BUILD_PORTABLE "Build portable application with dependency bundling" ON)
option(DEPLOY_QT "Deploy Qt libraries automatically" ON)

# MinGWä¾¿æ”œå¼æ§‹å»ºè¨­ç½®
if(BUILD_PORTABLE)
    # MinGWéœæ…‹éˆæ¥é‹è¡Œæ™‚åº«
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -static-libgcc -static-libstdc++")
    
    # ç‚ºæœ€çµ‚éƒ¨ç½²éšæ®µä¿ç•™å‹•æ…‹Qtéˆæ¥
    message(STATUS "ğŸš€ ä¾¿æ”œå¼æ§‹å»ºæ¨¡å¼ï¼šå°‡åœ¨éƒ¨ç½²éšæ®µåŒ…å«Qtå‹•æ…‹åº«")
endif()

# Qt6è¨­ç½®
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTOUIC ON)
set(CMAKE_AUTORCC ON)

# æ˜ç¢ºæŒ‡å®šQtè·¯å¾‘
set(Qt6_DIR "C:/Qt/6.9.1/mingw_64/lib/cmake/Qt6")
set(CMAKE_PREFIX_PATH "C:/Qt/6.9.1/mingw_64")

# æŸ¥æ‰¾Qt6æ ¸å¿ƒæ¨¡çµ„
find_package(Qt6 REQUIRED COMPONENTS 
    Core 
    Widgets 
    Network
    Gui
)

# æ¢ä»¶æ€§æŸ¥æ‰¾é¡å¤–æ¨¡çµ„
find_package(Qt6 QUIET COMPONENTS WebSockets Concurrent)

if(Qt6WebSockets_FOUND)
    message(STATUS "âœ… Qt6WebSockets found, WebSocket features enabled")
    set(HAVE_WEBSOCKETS ON)
    add_compile_definitions(HAVE_WEBSOCKETS)
else()
    message(WARNING "âš ï¸ Qt6WebSockets not found, WebSocket features will be disabled")
    set(HAVE_WEBSOCKETS OFF)
endif()

if(Qt6Concurrent_FOUND)
    message(STATUS "âœ… Qt6Concurrent found")
endif()

# MinGWç·¨è­¯å™¨ç‰¹å®šè¨­ç½®
if(MINGW)
    # UTF-8ç·¨ç¢¼æ”¯æŒ
    add_compile_options(-finput-charset=UTF-8 -fexec-charset=UTF-8)
    
    # å„ªåŒ–è¨­ç½®
    if(CMAKE_BUILD_TYPE STREQUAL "Release")
        add_compile_options(-O3 -march=native)
    endif()
    
    # ç§»é™¤mingw32ç‰¹å®šè­¦å‘Š
    add_compile_options(-Wno-unknown-pragmas)
    
    message(STATUS "ğŸ”§ MinGWç·¨è­¯é¸é …é…ç½®å®Œæˆ")
endif()

# æºæ–‡ä»¶
set(SOURCES
    main.cpp
    FramelessWindow.cpp
    CyberProgressBar.cpp
    LLMMainWindow.cpp
    LLMRequestItem_New.cpp
    OllamaLLMManager_Fixed.cpp
    
    # AIç®¡æ§ç³»çµ±æ¨¡çµ„
    AIPlayerGenerator.cpp
    AIDecisionEngine.cpp
    AIManagementWidget.cpp
)

# é ­æ–‡ä»¶
set(HEADERS
    AcademyTheme.h
    FramelessWindow.h
    CyberProgressBar.h
    LLMRequestItem_New.h
    LLMMainWindow.h
    OllamaLLMManager.h
    
    # AIç®¡æ§ç³»çµ±æ¨¡çµ„
    AIPlayerGenerator.h
    AIDecisionEngine.h
    AIManagementWidget.h
)

# å‰µå»ºå¯åŸ·è¡Œæ–‡ä»¶
add_executable(ai_llm_integration ${SOURCES} ${HEADERS})

# MinGWç‰¹å®šçš„éˆæ¥åº«
target_link_libraries(ai_llm_integration 
    Qt6::Core 
    Qt6::Widgets 
    Qt6::Network
    Qt6::Gui
)

# æ¢ä»¶æ€§éˆæ¥é¡å¤–æ¨¡çµ„
if(Qt6Concurrent_FOUND)
    target_link_libraries(ai_llm_integration Qt6::Concurrent)
    message(STATUS "âœ… Linking Qt6::Concurrent")
endif()

if(HAVE_WEBSOCKETS)
    target_link_libraries(ai_llm_integration Qt6::WebSockets)
    message(STATUS "âœ… Linking Qt6::WebSockets")
endif()

# Windowsç‰¹å®šç³»çµ±åº«
if(WIN32)
    target_link_libraries(ai_llm_integration 
        ws2_32 
        winmm 
        imm32 
        version
        ole32
        oleaut32
        uuid
        advapi32
        shell32
        user32
        kernel32
        gdi32
        comdlg32
        winspool
    )
endif()

# è¨­ç½®å¯åŸ·è¡Œæ–‡ä»¶å±¬æ€§
set_target_properties(ai_llm_integration PROPERTIES
    WIN32_EXECUTABLE TRUE
    OUTPUT_NAME "ai_llm_integration"
)

# è¼¸å‡ºé…ç½®ä¿¡æ¯
message(STATUS "")
message(STATUS "ğŸ¤– AI LLM Integration Module Configuration")
message(STATUS "============================================")
message(STATUS "ğŸ“‹ Module Version: ${PROJECT_VERSION}")
message(STATUS "ğŸ¯ Qt6 Version: ${Qt6_VERSION}")
message(STATUS "ğŸ”§ Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "ğŸ”¨ Compiler: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "ğŸ“ Source Directory: ${CMAKE_SOURCE_DIR}")
message(STATUS "ğŸ“¦ Binary Directory: ${CMAKE_BINARY_DIR}")
message(STATUS "ğŸŒ Qt Path: ${CMAKE_PREFIX_PATH}")
if(HAVE_WEBSOCKETS)
    message(STATUS "ğŸ”Œ WebSocket Support: Enabled")
else()
    message(STATUS "ğŸ”Œ WebSocket Support: Disabled")
endif()
message(STATUS "============================================")
message(STATUS "")

# éƒ¨ç½²é…ç½®ï¼ˆåƒ…Windowsï¼‰
if(DEPLOY_QT AND WIN32)
    # æŸ¥æ‰¾windeployqtå·¥å…·
    find_program(WINDEPLOYQT_EXECUTABLE 
        windeployqt 
        HINTS "C:/Qt/6.9.1/mingw_64/bin"
        PATHS "C:/Qt/6.9.1/mingw_64/bin"
    )
    
    if(WINDEPLOYQT_EXECUTABLE)
        message(STATUS "ğŸš€ Found windeployqt: ${WINDEPLOYQT_EXECUTABLE}")
        
        # å‰µå»ºéƒ¨ç½²ç›®éŒ„
        set(DEPLOY_DIR "${CMAKE_BINARY_DIR}/deploy")
        
        # éƒ¨ç½²å‘½ä»¤
        add_custom_target(deploy
            COMMAND ${CMAKE_COMMAND} -E make_directory ${DEPLOY_DIR}
            COMMAND ${CMAKE_COMMAND} -E copy $<TARGET_FILE:ai_llm_integration> ${DEPLOY_DIR}/
            COMMAND ${WINDEPLOYQT_EXECUTABLE} 
                --release 
                --no-translations 
                --no-system-d3d-compiler 
                --no-opengl-sw 
                --no-quick-import
                --force
                ${DEPLOY_DIR}/ai_llm_integration.exe
            DEPENDS ai_llm_integration
            COMMENT "ğŸš€ Deploying Qt libraries for portable distribution"
        )
        
        # å‰µå»ºä¾¿æ”œå¼æ‰“åŒ…
        add_custom_target(portable
            COMMAND ${CMAKE_COMMAND} -E make_directory ${DEPLOY_DIR}/portable
            COMMAND ${CMAKE_COMMAND} -E copy_directory ${DEPLOY_DIR} ${DEPLOY_DIR}/portable
            # è¤‡è£½MinGWé‹è¡Œæ™‚åº«
            COMMAND ${CMAKE_COMMAND} -E copy_if_different 
                "C:/Qt/6.9.1/mingw_64/bin/libgcc_s_seh-1.dll" 
                ${DEPLOY_DIR}/portable/
            COMMAND ${CMAKE_COMMAND} -E copy_if_different 
                "C:/Qt/6.9.1/mingw_64/bin/libstdc++-6.dll" 
                ${DEPLOY_DIR}/portable/
            COMMAND ${CMAKE_COMMAND} -E copy_if_different 
                "C:/Qt/6.9.1/mingw_64/bin/libwinpthread-1.dll" 
                ${DEPLOY_DIR}/portable/
            DEPENDS deploy
            COMMENT "ğŸ“¦ Creating portable application package with MinGW runtime"
        )
        
        message(STATUS "âœ… Deployment targets configured: 'deploy' and 'portable'")
    else()
        message(WARNING "âš ï¸ windeployqt not found at expected location")
    endif()
endif()

# å®‰è£è¦å‰‡
install(TARGETS ai_llm_integration
    RUNTIME DESTINATION bin
    LIBRARY DESTINATION lib
    ARCHIVE DESTINATION lib
)

# æœ€çµ‚é…ç½®è¼¸å‡º
message(STATUS "")
message(STATUS "ğŸ¯ Build Configuration Summary")
message(STATUS "===============================")
message(STATUS "ğŸ“¦ Portable Build: ${BUILD_PORTABLE}")
message(STATUS "ğŸš€ Auto Deploy: ${DEPLOY_QT}")
message(STATUS "ğŸ® Target: ai_llm_integration.exe")
message(STATUS "ğŸ”§ Toolchain: MinGW ${CMAKE_CXX_COMPILER_VERSION}")
message(STATUS "===============================")
message(STATUS "")
message(STATUS "ğŸ’¡ Usage:")
message(STATUS "   cmake --build . --config Release")
if(DEPLOY_QT)
    message(STATUS "   cmake --build . --target deploy")
    message(STATUS "   cmake --build . --target portable")
endif()
message(STATUS "")
