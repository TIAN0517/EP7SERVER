# ========================================================================
# RANOnline AI LLM Integration - VMç›¸å®¹ç‰ˆ CMakeé…ç½®
# ç‰ˆæœ¬: 3.1.0 VMå°ˆç”¨ç‰ˆ
# é–‹ç™¼åœ˜éšŠ: JyæŠ€è¡“åœ˜éšŠ
# 
# ğŸ¯ VM/é›²ç«¯ä¸»æ©Ÿå„ªåŒ–ç‰¹æ€§:
# âœ… éœæ…‹éˆæ¥å„ªåŒ– (æœ€å°åŒ–DLLä¾è³´)
# âœ… è»Ÿé«”æ¸²æŸ“å°ˆç”¨æ§‹å»º
# âœ… å®Œæ•´ä¾è³´æ‰“åŒ…
# âœ… VMç’°å¢ƒè‡ªå‹•åµæ¸¬
# âœ… é›™ç‰ˆæœ¬æ§‹å»º (é€šç”¨ç‰ˆ + VMç²¾ç°¡ç‰ˆ)
# ========================================================================

cmake_minimum_required(VERSION 3.22)

# å°ˆæ¡ˆè¨­å®š
project(ai_llm_integration_vm 
    VERSION 3.1.0 
    DESCRIPTION "RANOnline AI LLM Integration - VM Compatible Version"
    LANGUAGES CXX)

# ç·¨è­¯å™¨æ¨™æº–
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

# æ§‹å»ºé¡å‹
if(NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE "Release" CACHE STRING "Build type" FORCE)
endif()

# Windowsç‰¹å®šè¨­å®š
if(WIN32)
    set(CMAKE_WIN32_EXECUTABLE TRUE)
    set(CMAKE_SYSTEM_VERSION 10.0)
endif()

# VMæ§‹å»ºé¸é …
option(BUILD_VM_COMPATIBLE "Build VM compatible version" ON)
option(BUILD_STATIC "Build with static linking" ON)
option(BUILD_FULL_BUNDLE "Build full dependency bundle" ON)

# ========================================================================
# Qt6 è¨­å®š
# ========================================================================

# è‡ªå‹•åµæ¸¬Qt6è·¯å¾‘
set(QT_VERSION_MAJOR 6)
set(Qt6_DIR_CANDIDATES
    "C:/Qt/6.9.1/mingw_64/lib/cmake/Qt6"
    "C:/Qt/6.8.0/mingw_64/lib/cmake/Qt6"
    "C:/Qt/6.7.0/mingw_64/lib/cmake/Qt6"
    "C:/Qt/6.6.0/mingw_64/lib/cmake/Qt6"
    "C:/Qt/6.5.0/mingw_64/lib/cmake/Qt6"
)

foreach(QT_DIR ${Qt6_DIR_CANDIDATES})
    if(EXISTS "${QT_DIR}")
        set(Qt6_DIR "${QT_DIR}")
        message(STATUS "Found Qt6 at: ${Qt6_DIR}")
        break()
    endif()
endforeach()

if(NOT Qt6_DIR)
    message(FATAL_ERROR "Qt6 not found! Please install Qt6 or set Qt6_DIR manually.")
endif()

# Qt6 çµ„ä»¶
find_package(Qt6 REQUIRED COMPONENTS 
    Core 
    Widgets 
    Gui 
    Network
    OpenGL
    OpenGLWidgets
)

# Qt6 è‡ªå‹•å·¥å…·
set(CMAKE_AUTOMOC ON)
set(CMAKE_AUTORCC ON)
set(CMAKE_AUTOUIC ON)

# ========================================================================
# ç·¨è­¯å™¨è¨­å®š
# ========================================================================

# MinGW/GCC è¨­å®š
if(CMAKE_COMPILER_IS_GNUCXX OR CMAKE_CXX_COMPILER_ID MATCHES "GNU")
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -Wall -Wextra -O3")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} -O3 -DNDEBUG")
    
    # VMç›¸å®¹æ€§ç·¨è­¯é¸é …
    if(BUILD_VM_COMPATIBLE)
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DQT_NO_OPENGL_ES_2")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -DQT_OPENGL_SOFTWARE")
    endif()
    
    # éœæ…‹éˆæ¥è¨­å®š
    if(BUILD_STATIC)
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} -static-libgcc -static-libstdc++")
        set(CMAKE_EXE_LINKER_FLAGS "${CMAKE_EXE_LINKER_FLAGS} -static-libgcc -static-libstdc++")
    endif()
endif()

# MSVC è¨­å®š
if(MSVC)
    set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /W3 /O2")
    set(CMAKE_CXX_FLAGS_RELEASE "${CMAKE_CXX_FLAGS_RELEASE} /O2 /DNDEBUG")
    
    if(BUILD_VM_COMPATIBLE)
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /DQT_NO_OPENGL_ES_2")
        set(CMAKE_CXX_FLAGS "${CMAKE_CXX_FLAGS} /DQT_OPENGL_SOFTWARE")
    endif()
    
    # éœæ…‹é‹è¡Œæ™‚éˆæ¥
    if(BUILD_STATIC)
        set(CMAKE_MSVC_RUNTIME_LIBRARY "MultiThreaded$<$<CONFIG:Debug>:Debug>")
    endif()
endif()

# ========================================================================
# æºæ–‡ä»¶æ”¶é›†
# ========================================================================

# ä¸»è¦æºæ–‡ä»¶
set(SOURCES
    LLMMainWindow.cpp
    OllamaLLMManager.cpp
)

# VMç‰ˆæœ¬å’Œé€šç”¨ç‰ˆæœ¬çš„ä¸»ç¨‹åº
set(MAIN_SOURCE_STANDARD main_enterprise_compatible.cpp)
set(MAIN_SOURCE_VM main_vm_optimized.cpp)

# é ­æ–‡ä»¶
set(HEADERS
    LLMMainWindow.h
    OllamaLLMManager.h
    AcademyTheme.h
)

# è³‡æºæ–‡ä»¶
set(RESOURCES
    Resources/icons.qrc
)

# æª¢æŸ¥æºæ–‡ä»¶å­˜åœ¨æ€§
foreach(SOURCE_FILE ${SOURCES} ${HEADERS})
    if(NOT EXISTS "${CMAKE_CURRENT_SOURCE_DIR}/${SOURCE_FILE}")
        message(WARNING "Source file not found: ${SOURCE_FILE}")
    endif()
endforeach()

# ========================================================================
# Windows è³‡æºæ–‡ä»¶ç”Ÿæˆ
# ========================================================================

if(WIN32)
    # å‰µå»º .rc æ–‡ä»¶
    set(RC_FILE "${CMAKE_CURRENT_BINARY_DIR}/app_resources.rc")
    set(ICO_FILE "${CMAKE_CURRENT_SOURCE_DIR}/Resources/jy1.ico")
    
    # æª¢æŸ¥åœ–æ¨™æ–‡ä»¶
    if(NOT EXISTS "${ICO_FILE}")
        set(ICO_FILE "${CMAKE_CURRENT_SOURCE_DIR}/jy1.ico")
    endif()
    
    if(EXISTS "${ICO_FILE}")
        file(WRITE "${RC_FILE}" 
"IDI_ICON1 ICON \"${ICO_FILE}\"
VS_VERSION_INFO VERSIONINFO
FILEVERSION 3,1,0,0
PRODUCTVERSION 3,1,0,0
FILEFLAGSMASK 0x17L
FILEFLAGS 0x0L
FILEOS 0x4L
FILETYPE 0x1L
FILESUBTYPE 0x0L
BEGIN
    BLOCK \"StringFileInfo\"
    BEGIN
        BLOCK \"040904b0\"
        BEGIN
            VALUE \"CompanyName\", \"JyæŠ€è¡“åœ˜éšŠ\"
            VALUE \"FileDescription\", \"RANOnline AI LLM Integration - VM Compatible\"
            VALUE \"FileVersion\", \"3.1.0.0\"
            VALUE \"InternalName\", \"ai_llm_integration_vm\"
            VALUE \"LegalCopyright\", \"Copyright (C) 2025 JyæŠ€è¡“åœ˜éšŠ\"
            VALUE \"OriginalFilename\", \"ai_llm_integration_vm.exe\"
            VALUE \"ProductName\", \"RANOnline AI LLM Integration VM Edition\"
            VALUE \"ProductVersion\", \"3.1.0.0\"
        END
    END
    BLOCK \"VarFileInfo\"
    BEGIN
        VALUE \"Translation\", 0x409, 1200
    END
END
")
        list(APPEND SOURCES ${RC_FILE})
        message(STATUS "Windows resource file created: ${RC_FILE}")
    else()
        message(WARNING "Icon file not found: ${ICO_FILE}")
    endif()
endif()

# ========================================================================
# åŸ·è¡Œæª”ç›®æ¨™ - é€šç”¨ç‰ˆæœ¬
# ========================================================================

add_executable(ai_llm_integration_standard
    ${MAIN_SOURCE_STANDARD}
    ${SOURCES}
    ${RESOURCES}
)

target_link_libraries(ai_llm_integration_standard
    Qt6::Core
    Qt6::Widgets
    Qt6::Gui
    Qt6::Network
    Qt6::OpenGL
    Qt6::OpenGLWidgets
)

target_include_directories(ai_llm_integration_standard PRIVATE
    ${CMAKE_CURRENT_SOURCE_DIR}
    ${CMAKE_CURRENT_BINARY_DIR}
)

# è¨­ç½®è¼¸å‡ºåç¨±
set_target_properties(ai_llm_integration_standard PROPERTIES
    OUTPUT_NAME "ai_llm_integration"
    RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}"
)

# ========================================================================
# åŸ·è¡Œæª”ç›®æ¨™ - VMç›¸å®¹ç‰ˆæœ¬
# ========================================================================

if(BUILD_VM_COMPATIBLE)
    add_executable(ai_llm_integration_vm
        ${MAIN_SOURCE_VM}
        ${SOURCES}
        ${RESOURCES}
    )

    target_link_libraries(ai_llm_integration_vm
        Qt6::Core
        Qt6::Widgets
        Qt6::Gui
        Qt6::Network
    )

    target_include_directories(ai_llm_integration_vm PRIVATE
        ${CMAKE_CURRENT_SOURCE_DIR}
        ${CMAKE_CURRENT_BINARY_DIR}
    )

    # VMç‰ˆæœ¬ç‰¹å®šç·¨è­¯å®šç¾©
    target_compile_definitions(ai_llm_integration_vm PRIVATE
        QT_NO_OPENGL_ES_2
        QT_OPENGL_SOFTWARE
        VM_COMPATIBLE_BUILD
    )

    # è¨­ç½®è¼¸å‡ºåç¨±
    set_target_properties(ai_llm_integration_vm PROPERTIES
        OUTPUT_NAME "ai_llm_integration_vm"
        RUNTIME_OUTPUT_DIRECTORY "${CMAKE_BINARY_DIR}"
    )
endif()

# ========================================================================
# éƒ¨ç½²ç›®æ¨™
# ========================================================================

# é€šç”¨ç‰ˆæœ¬éƒ¨ç½²
add_custom_target(deploy_standard
    COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/deploy_standard"
    COMMAND ${CMAKE_COMMAND} -E copy "$<TARGET_FILE:ai_llm_integration_standard>" "${CMAKE_BINARY_DIR}/deploy_standard/"
    DEPENDS ai_llm_integration_standard
    COMMENT "Deploying standard version..."
)

# VMç‰ˆæœ¬éƒ¨ç½²
if(BUILD_VM_COMPATIBLE)
    add_custom_target(deploy_vm
        COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/deploy_vm"
        COMMAND ${CMAKE_COMMAND} -E copy "$<TARGET_FILE:ai_llm_integration_vm>" "${CMAKE_BINARY_DIR}/deploy_vm/"
        DEPENDS ai_llm_integration_vm
        COMMENT "Deploying VM compatible version..."
    )
endif()

# å®Œæ•´éƒ¨ç½² (åŒ…å«æ‰€æœ‰ä¾è³´)
if(BUILD_FULL_BUNDLE)
    find_program(WINDEPLOYQT_EXECUTABLE windeployqt HINTS ${Qt6_DIR}/../../../bin)
    
    if(WINDEPLOYQT_EXECUTABLE)
        # é€šç”¨ç‰ˆæœ¬å®Œæ•´éƒ¨ç½²
        add_custom_target(bundle_standard
            COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/bundle_standard"
            COMMAND ${CMAKE_COMMAND} -E copy "$<TARGET_FILE:ai_llm_integration_standard>" "${CMAKE_BINARY_DIR}/bundle_standard/"
            COMMAND ${WINDEPLOYQT_EXECUTABLE} --verbose 2 --dir "${CMAKE_BINARY_DIR}/bundle_standard" 
                    --force --compiler-runtime --no-translations 
                    "${CMAKE_BINARY_DIR}/bundle_standard/ai_llm_integration.exe"
            DEPENDS ai_llm_integration_standard
            COMMENT "Creating standard version bundle with all dependencies..."
        )
        
        # VMç‰ˆæœ¬å®Œæ•´éƒ¨ç½²
        if(BUILD_VM_COMPATIBLE)
            add_custom_target(bundle_vm
                COMMAND ${CMAKE_COMMAND} -E make_directory "${CMAKE_BINARY_DIR}/bundle_vm"
                COMMAND ${CMAKE_COMMAND} -E copy "$<TARGET_FILE:ai_llm_integration_vm>" "${CMAKE_BINARY_DIR}/bundle_vm/"
                COMMAND ${WINDEPLOYQT_EXECUTABLE} --verbose 2 --dir "${CMAKE_BINARY_DIR}/bundle_vm" 
                        --force --compiler-runtime --no-opengl-sw
                        "${CMAKE_BINARY_DIR}/bundle_vm/ai_llm_integration_vm.exe"
                DEPENDS ai_llm_integration_vm
                COMMENT "Creating VM compatible version bundle with minimal dependencies..."
            )
        endif()
    else()
        message(WARNING "windeployqt not found. Bundle targets will not work properly.")
    endif()
endif()

# ========================================================================
# å®‰è£è¨­å®š
# ========================================================================

install(TARGETS ai_llm_integration_standard
    RUNTIME DESTINATION bin
    COMPONENT standard
)

if(BUILD_VM_COMPATIBLE)
    install(TARGETS ai_llm_integration_vm
        RUNTIME DESTINATION bin
        COMPONENT vm
    )
endif()

# ========================================================================
# æ§‹å»ºä¿¡æ¯é¡¯ç¤º
# ========================================================================

message(STATUS "========================================")
message(STATUS "RANOnline AI LLM Integration - VM Edition")
message(STATUS "========================================")
message(STATUS "Project: ${PROJECT_NAME}")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build Type: ${CMAKE_BUILD_TYPE}")
message(STATUS "Qt6 Path: ${Qt6_DIR}")
message(STATUS "C++ Standard: ${CMAKE_CXX_STANDARD}")
message(STATUS "VM Compatible: ${BUILD_VM_COMPATIBLE}")
message(STATUS "Static Linking: ${BUILD_STATIC}")
message(STATUS "Full Bundle: ${BUILD_FULL_BUNDLE}")
message(STATUS "========================================")

# æ§‹å»ºç›®æ¨™æ‘˜è¦
get_property(TARGETS DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR} PROPERTY BUILDSYSTEM_TARGETS)
message(STATUS "Available targets:")
foreach(TARGET ${TARGETS})
    message(STATUS "  - ${TARGET}")
endforeach()
message(STATUS "========================================")
